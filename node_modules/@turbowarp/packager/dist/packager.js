!function(e,n){"object"==typeof exports&&"object"==typeof module?module.exports=n(require("cross-fetch"),require("@turbowarp/sbdl"),require("@fiahfy/icns"),require("jszip")):"function"==typeof define&&define.amd?define(["cross-fetch","@turbowarp/sbdl","@fiahfy/icns","jszip"],n):"object"==typeof exports?exports.packager=n(require("cross-fetch"),require("@turbowarp/sbdl"),require("@fiahfy/icns"),require("jszip")):e.packager=n(e["cross-fetch"],e["@turbowarp/sbdl"],e["@fiahfy/icns"],e.jszip)}(global,(function(e,n,t,o){return function(e){var n={},t={1:0};function o(t){if(n[t])return n[t].exports;var s=n[t]={i:t,l:!1,exports:{}};return e[t].call(s.exports,s,s.exports,o),s.l=!0,s.exports}return o.e=function(n){if(0!==t[n]){var o=require("./"+({0:"icns",2:"sha256"}[n]||n)+".js"),s=o.modules,r=o.ids;for(var i in s)e[i]=s[i];for(var a=0;a<r.length;a++)t[r[a]]=0}return Promise.all([])},o.m=e,o.c=n,o.d=function(e,n,t){o.o(e,n)||Object.defineProperty(e,n,{enumerable:!0,get:t})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(e,n){if(1&n&&(e=o(e)),8&n)return e;if(4&n&&"object"==typeof e&&e&&e.__esModule)return e;var t=Object.create(null);if(o.r(t),Object.defineProperty(t,"default",{enumerable:!0,value:e}),2&n&&"string"!=typeof e)for(var s in e)o.d(t,s,function(n){return e[n]}.bind(null,s));return t},o.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(n,"a",n),n},o.o=function(e,n){return Object.prototype.hasOwnProperty.call(e,n)},o.p="",o.oe=function(e){process.nextTick((function(){throw e}))},o(o.s=7)}([function(e,n){e.exports={APP_NAME:"TurboWarp Packager",WEBSITE:"https://packager.turbowarp.org/",COPYRIGHT_NOTICE:'Copyright (C) 2021-2022 Thomas Weber\n\nLicensed under the Apache License, Version 2.0 (the "License");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an "AS IS" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.',ACCENT_COLOR:"#ff4c4c",SOURCE_CODE:"https://github.com/TurboWarp/packager",FEEDBACK_PRIMARY:{name:"Scratch",link:"https://scratch.mit.edu/users/GarboMuffin/#comments"},FEEDBACK_SECONDARY:{name:"GitHub",link:"https://github.com/TurboWarp/packager/issues"},DONATE:"https://github.com/sponsors/GarboMuffin"}},function(e,n){e.exports=require("path")},function(e,n){e.exports=require("util")},function(e,n){e.exports=require("fs")},function(n,t){n.exports=e},function(e,t){e.exports=n},function(e){e.exports=JSON.parse('{"a":"@turbowarp/packager"}')},function(e,n,t){"use strict";t.r(n),t.d(n,"Packager",(function(){return j})),t.d(n,"Image",(function(){return X})),t.d(n,"loadProject",(function(){return D}));class o{constructor(e,n){this.type=e,this.detail=n?n.detail:{}}}var s=async e=>{if("object"==typeof crypto&&crypto.subtle&&crypto.subtle.digest){const n=await crypto.subtle.digest("SHA-256",e);return Array.from(new Uint8Array(n)).map(e=>e.toString(16).padStart(2,"0")).join("")}const n=new(0,(await t.e(2).then(t.t.bind(null,15,7))).default);return n.update(new Uint8Array(e)),n.digest("hex")};var r=e=>e.replace(/["'<>&]/g,e=>{switch(e){case'"':return"&quot;";case"'":return"&apos;";case"<":return"&lt;";case">":return"&gt;";case"&":return"&amp;"}});const i=e=>["https://packagerdata.turbowarp.org/"+e,"https://blobs.turbowarp.xyz/"+e],a=e=>"scaffolding/"+e;var c={"nwjs-win64":{src:i("nwjs-v0.68.1-win-x64.zip"),sha256:"82527d29f060bad7ec041f7c0536b1376f8bad5e5584adf7e3cf7205755a106c",estimatedSize:119821598},"nwjs-win32":{src:i("nwjs-v0.68.1-win-ia32.zip"),sha256:"7dd3104c2726082a8acd8973af2b2b223bc97960b722ec141b9bf07d84a0281b",estimatedSize:112613344},"nwjs-mac":{src:i("nwjs-v0.68.1-osx-x64.zip"),sha256:"4b1356302738a45f7ee212f6ecb997eb5d31403bfc45a7dd58429c968a1f581a",estimatedSize:119091132},"nwjs-linux-x64":{src:i("nwjs-v0.68.1-linux-x64.zip"),sha256:"5f597add1a2b6f13592117cc955111cea8211c13b21165e29c6616f385df5b94",estimatedSize:135854818},"electron-win32":{src:i("electron-v21.2.3-win32-ia32.zip"),sha256:"ee813a8dc4050c7d3a3cc80233bf5f4ddd0483e1c934eb69d735a3b3563ce3bf",estimatedSize:89317110},"electron-win64":{src:i("electron-v21.2.3-win32-x64.zip"),sha256:"b1695f0528567ecc1f7e667520c7770321df35d058841e24c4e9793f4e43e56a",estimatedSize:95073928},"electron-mac":{src:i("electron-v21.0.1-macos-universal.zip"),sha256:"c31d1ef26f7b6230881a11308ebf8f4487a1a3fb7a151da0972fad77bc9e6acf",estimatedSize:154789837},"electron-linux64":{src:i("electron-v21.0.1-linux-x64.zip"),sha256:"4fd6d7b5a65f44a43165ae77d0484db992b30d6efba478a192e984506fbd52b6",estimatedSize:90635371},"webview-mac":{src:i("WebView-macos-5.zip"),sha256:"b5636571cd9be2aae2f6dac1ab090fdf829c8fdfe91f462cc2feb2d324705f9f",estimatedSize:3425601},scaffolding:{src:a("scaffolding-full.js"),estimatedSize:4564032,useBuildId:!0},"scaffolding-min":{src:a("scaffolding-min.js"),estimatedSize:2530463,useBuildId:!0},addons:{src:a("addons.js"),estimatedSize:19931,useBuildId:!0}};Error;Error;class l extends Error{constructor(e){super(`Could not fetch ${e} for unknown reason.`),this.name="UnknownNetworkError",this.url=e}}class d extends Error{constructor(e){super(e),this.name="OutdatedPackagerError"}}class p extends Error{constructor(e,n){super(e),this.status=n,this.name="HTTPError"}}Error;const u=e=>Math.max(0,Math.min(1,e)),f=[400,404];var h=async e=>{const{type:n,progressCallback:t,timeout:o,estimatedSize:s,abortTarget:r}=e,i=e=>new Promise((i,a)=>{const c=new XMLHttpRequest;c.onload=()=>{d(),200===c.status?i(c.response):a(new p(`Couldn't fetch ${e}: status code ${c.status}`,c.status))},c.onerror=()=>{d(),a(new l(e))},t&&(c.onprogress=e=>{e.lengthComputable?t(u(e.loaded/e.total)):s&&t(u(e.loaded/s))}),c.responseType=n,c.open("GET",e),c.send();const d=()=>{f&&f(),h&&clearTimeout(h)};let f,h;if(r){const n=()=>{c.abort(),d(),a(new Error(`Couldn't fetch ${e}: aborted`))};r.addEventListener("abort",n),f=()=>{r.removeEventListener("abort",n)}}o&&(h=setTimeout(()=>{c.abort(),d(),a(new Error(`Couldn't fetch ${e}: timed out`))},o))}),a=Array.isArray(e.url)?e.url:[e.url];if(0===a.length)throw new Error("no URLs");let c;for(const e of a)try{return await i(e)}catch(e){if(e instanceof p&&f.includes(e.status))throw e;(!c||c instanceof l&&!(e instanceof l))&&(c=e)}throw c};const g=e=>new Promise((n,t)=>{const o=new FileReader;o.onload=()=>n(o.result),o.onerror=()=>t(new Error("Cannot read as array buffer: "+o.error)),o.readAsArrayBuffer(e)}),m=e=>new Promise((n,t)=>{e.toBlob(e=>{e?n(e):t(new Error("Could not read <canvas> as blob"))})});var w=async e=>{const{Icns:n,Buffer:o}=await t.e(0).then(t.bind(null,16)),s=new Blob([e],{type:"image/png"}),r=URL.createObjectURL(s),i=await(a=r,new Promise((e,n)=>{const t=new Image;t.onload=()=>e(t),t.onerror=()=>n(new Error("Could not load image: "+a)),t.src=a}));var a;const c=[{type:"ic04",size:16},{type:"ic07",size:128},{type:"ic08",size:256},{type:"ic09",size:512},{type:"ic10",size:1024},{type:"ic11",size:32},{type:"ic12",size:64},{type:"ic13",size:256},{type:"ic14",size:512}].filter(e=>16===e.size||i.width>=e.size&&i.height>=e.size),l=document.createElement("canvas"),d=l.getContext("2d");if(!d)throw new Error("cannot get canvas rendering context");const p=new n.Icns;for(const e of c){const t=e.size;l.width=t,l.height=t,d.drawImage(i,0,0,t,t);const s=await m(l),r=await g(s),a=await n.IcnsImage.fromPNG(o.from(r),e.type);p.append(a)}return p.data};const b="c5ed215450b94f3f7fa1a2864fad7b74aa3ef98cbc7a29f534cd19460b0ac6a8",y=e=>{const n=e=>(40===e&&(e=60),41===e&&(e=62),e-42),t=e.indexOf(","),o=+e.substring(0,t).split("").map(e=>String.fromCharCode(e.charCodeAt(0)-49)).join(""),s=new ArrayBuffer((r=o)%4==0?r:r+(4-r%4));var r;const i=new Uint32Array(s);for(let o=t+1,s=0;o<e.length;o+=5,s++)i[s]=85*n(e.charCodeAt(o+4))*85*85*85+85*n(e.charCodeAt(o+3))*85*85+85*n(e.charCodeAt(o+2))*85+85*n(e.charCodeAt(o+1))+n(e.charCodeAt(o));return new Uint8Array(s,0,o)},E=e=>{if("dict"===e.tagName){const n={};for(const t of e.children)"key"===t.tagName&&(n[t.textContent]=E(t.nextElementSibling));return n}return"array"===e.tagName?Array.from(e.children).map(E):"string"===e.tagName?e.textContent:"true"===e.tagName||"false"!==e.tagName&&(console.warn("unknown plist xml",e),null)},v=(e,n)=>{if(Array.isArray(n)){const t=e.createElement("array");for(const o of n)t.appendChild(v(e,o));return t}if("object"==typeof n){const t=e.createElement("dict");for(const[o,s]of Object.entries(n)){const n=e.createElement("key");n.textContent=o;const r=v(e,s);t.appendChild(n),t.appendChild(r)}return t}if("string"==typeof n){const t=e.createElement("string");return t.textContent=n,t}if("boolean"==typeof n){return e.createElement(n.toString())}return console.warn("unknown plist value",n),v(e,""+n)};var S=t(0);const A=e=>{const n=(e=>{const n=e.red/255,t=e.green/255,o=e.blue/255,s=Math.min(Math.min(n,t),o),r=Math.max(Math.max(n,t),o);let i=0,a=0;if(s!==r){i=60*((n===s?3:t===s?5:1)-(n===s?t-o:t===s?o-n:n-t)/(r-s))%360,a=(r-s)/r}return{hue:i,saturation:a,value:r}})((e=>{const n=parseInt(e.substring(1),16);return{red:n>>16&255,green:n>>8&255,blue:255&n}})(e));n.value-=.1;return(e=>{const n=e=>e.toString(16).padStart(2,"0");return`#${n(e.red)}${n(e.green)}${n(e.blue)}`})((e=>{let n=e.hue%360;n<0&&(n+=360);const t=Math.max(0,Math.min(e.saturation,1)),o=Math.max(0,Math.min(e.value,1)),s=Math.floor(n/60),r=n/60-s,i=o*(1-t),a=o*(1-t*r),c=o*(1-t*(1-r));let l,d,p;switch(s){default:case 0:l=o,d=c,p=i;break;case 1:l=a,d=o,p=i;break;case 2:l=i,d=o,p=c;break;case 3:l=i,d=a,p=o;break;case 4:l=c,d=i,p=o;break;case 5:l=o,d=i,p=a}return{red:Math.floor(255*l),green:Math.floor(255*d),blue:Math.floor(255*p)}})(n))};let I=null;const O=async()=>(await Promise.resolve().then(t.t.bind(null,10,7))).default,x=(e,n,t)=>{e.files[n]=t},R={title:S.APP_NAME,homepage:S.WEBSITE,license:S.COPYRIGHT_NOTICE},T={title:"Scratch",homepage:"https://scratch.mit.edu/",license:'Copyright (c) 2016, Massachusetts Institute of Technology\nAll rights reserved.\n\nRedistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:\n\n1. Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer.\n\n2. Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution.\n\n3. Neither the name of the copyright holder nor the names of its contributors may be used to endorse or promote products derived from this software without specific prior written permission.\n\nTHIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.'},C={title:"Electron",homepage:"https://www.electronjs.org/",license:'Copyright (c) Electron contributors\nCopyright (c) 2013-2020 GitHub Inc.\n\nPermission is hereby granted, free of charge, to any person obtaining\na copy of this software and associated documentation files (the\n"Software"), to deal in the Software without restriction, including\nwithout limitation the rights to use, copy, modify, merge, publish,\ndistribute, sublicense, and/or sell copies of the Software, and to\npermit persons to whom the Software is furnished to do so, subject to\nthe following conditions:\n\nThe above copyright notice and this permission notice shall be\nincluded in all copies or substantial portions of the Software.\n\nTHE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,\nEXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF\nMERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND\nNONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE\nLIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION\nOF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION\nWITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.'},N=`/*!\nParts of this script are from the ${S.APP_NAME} <${S.WEBSITE}>, licensed as follows:\n${R.license}\n\nParts of this script are from Scratch <https://scratch.mit.edu/>, licensed as follows:\n${T.license}\n*/\n`,L=e=>`<style>body { font-family: sans-serif; }</style>${`<h2>The following entries were added by the ${S.APP_NAME}</h2>`}${e.map(({title:e,license:n,homepage:t},o)=>`\n<div class="product">\n<span class="title">${r(e)}</span>\n<span class="homepage"><a href="${r(t)}">homepage</a></span>\n<input type="checkbox" hidden id="p4-${o}">\n<label class="show" for="p4-${o}" tabindex="0"></label>\n<div class="licence">\n<pre>${r(n)}</pre>\n</div>\n</div>\n`).join("\n")}`,k=e=>`When you try to double click on the app to run it, you will probably see this warning:\n"${e.app.packageName} cannot be opened because the developer cannot be verified."\nThis is normal. Press cancel.\n\nTo run the app:\n1) Control+click on the app file (${e.app.packageName} in the same folder as this document) and select "Open".\n2) If a warning appears, select "Open" if it's an option.\n3) If a warning appears but "Open" isn't an option, press "Cancel" and repeat from step 1.\n   The open button will appear the second time the warning appears.\n\nAfter completing these steps, the app should run without any further warnings.\n\nFeel free to drag the app into your Applications folder.\n`;class P extends class{constructor(){this._events={}}addEventListener(e,n){this._events[e]||(this._events[e]=[]),this._events[e].push(n)}removeEventListener(e,n){const t=this._events[e];t&&(this._events[e]=t.filter(e=>e!==n))}dispatchEvent(e){const n=this._events[e.type];if(n)for(const t of n)t(e)}}{constructor(){super(),this.project=null,this.options=P.DEFAULT_OPTIONS(),this.aborted=!1,this.used=!1}abort(){this.aborted||(this.aborted=!0,this.dispatchEvent(new Event("abort")))}ensureNotAborted(){if(this.aborted)throw new Error("Aborted")}async fetchLargeAsset(e,n){this.ensureNotAborted();const t=c[e];if(!t)throw new Error("Invalid asset: "+e);if("undefined"!=typeof __ASSETS__&&__ASSETS__[t.src])return __ASSETS__[t.src];const r=n=>this.dispatchEvent(new o("large-asset-fetch",{detail:{asset:e,progress:n}}));let i;r(0);let a=!1;try{const e=await I.getCachedAsset(t);e&&(i=e,a=!0,r(.5))}catch(e){console.warn(e)}if(!i){let e=t.src;t.useBuildId&&(e+="?"+b),i=await h({url:e,type:n,estimatedSize:t.estimatedSize,progressCallback:e=>{r(e)},abortTarget:this})}if(t.useBuildId&&(l=b,(p=i).endsWith("=^..^=")&&!p.endsWith(l+" =^..^=")))throw new d("Build ID does not match.");var l,p;if(t.sha256){const n=await s(i);if(n!==t.sha256)throw new Error(`Hash mismatch for ${e}, found ${n} but expected ${t.sha256}`)}if(!a)try{await I.cacheAsset(t,i)}catch(e){console.warn(e)}return r(1),i}getAddonOptions(){return{...this.options.chunks,specialCloudBehaviors:this.options.cloudVariables.specialCloudBehaviors,unsafeCloudBehaviors:this.options.cloudVariables.unsafeCloudBehaviors,pause:this.options.controls.pause.enabled}}async loadResources(){const e=[N];this.project.analysis.usesMusic?e.push(await this.fetchLargeAsset("scaffolding","text")):e.push(await this.fetchLargeAsset("scaffolding-min","text")),Object.values(this.getAddonOptions()).some(e=>e)&&e.push(await this.fetchLargeAsset("addons","text")),this.script=e.join("\n").replace(/<\/script>/g,"</scri'+'pt>")}computeWindowSize(){let e=this.options.stageWidth,n=this.options.stageHeight;return(this.options.controls.greenFlag.enabled||this.options.controls.stopAll.enabled||this.options.controls.pause.enabled)&&(n+=48),{width:e,height:n}}getPlistPropertiesForPrimaryExecutable(){return{CFBundleIdentifier:"org.turbowarp.packager.userland."+this.options.app.packageName,CFBundleName:this.options.app.windowTitle,CFBundleDisplayName:this.options.app.windowTitle,CFBundleExecutable:this.options.app.packageName,CFBundleVersion:this.options.app.version,CFBundleShortVersionString:this.options.app.version,LSApplicationCategoryType:"public.app-category.games"}}async updatePlist(e,n,t){const o=(e=>{const n=(new DOMParser).parseFromString(e,"text/xml").children[0].children[0];return E(n)})(await e.file(n).async("string"));Object.assign(o,t),e.file(n,(e=>{const n=document.implementation.createDocument(null,"plist"),t=n.documentElement;t.setAttribute("version","1.0"),t.appendChild(v(n,e));return'<?xml version="1.0" encoding="UTF-8"?>\n<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">\n'+(new XMLSerializer).serializeToString(n)})(o))}async addNwJS(e){const n=await this.fetchLargeAsset(this.options.target,"arraybuffer"),t=await(await O()).loadAsync(n),o=this.options.target.startsWith("nwjs-win"),s="nwjs-mac"===this.options.target,r=this.options.target.startsWith("nwjs-linux"),i=Object.keys(t.files)[0].split("/")[0],a=new(await O()),c=this.options.app.packageName;for(const e of Object.keys(t.files)){const n=t.files[e];let l=e.replace(i,c);o?l=l.replace("nw.exe",c+".exe"):s?l=l.replace("nwjs.app",c+".app"):r&&(l=l.replace(/nw$/,c)),x(a,l,n)}const l=await I.getAppIcon(this.options.app.icon),d={name:c,main:"main.js",version:this.options.app.version,window:{width:this.computeWindowSize().width,height:this.computeWindowSize().height,icon:"icon.png"}};let p;if(o)p=c+"/";else if(s){a.file(`${c}/How to run ${c}.txt`,k(this.options));const e=await w(l);a.file(`${c}/${c}.app/Contents/Resources/app.icns`,e),p=`${c}/${c}.app/Contents/Resources/app.nw/`}else if(r){const e='#!/bin/bash\ncd "$(dirname "$0")"\n./'+c;a.file(c+"/start.sh",e,{unixPermissions:33261}),p=c+"/"}for(const n of Object.keys(e.files))x(a,p+n,e.files[n]);a.file(p+"icon.png",l),a.file(p+"package.json",JSON.stringify(d,null,4)),a.file(p+"main.js","\n    const start = () => nw.Window.open('index.html', {\n      position: 'center',\n      new_instance: true\n    });\n    nw.App.on('open', start);\n    start();");const u=c+"/credits.html",f=await a.file(u).async("string");return a.file(u,f+L([R,T])),a}async addElectron(e){const n=await this.fetchLargeAsset(this.options.target,"arraybuffer"),t=await(await O()).loadAsync(n),o=this.options.target.includes("win"),s=this.options.target.includes("mac"),r=this.options.target.includes("linux"),i=new(await O()),a=this.options.app.packageName;for(const e of Object.keys(t.files)){const n=t.files[e];let c;c=s?e:`${a}/${e}`,o?c=c.replace("electron.exe",a+".exe"):s?(c=c.replace("Electron.app",a+".app"),c=c.replace(/Electron$/,a)):r&&(c=c.replace(/electron$/,a)),x(i,c,n)}const c=s?"":a+"/",l=await i.file(c+"LICENSES.chromium.html").async("string");i.file(c+"licenses.html",l+L([R,T,C])),i.remove(c+"LICENSE.txt"),i.remove(c+"LICENSES.chromium.html"),i.remove(c+"LICENSE"),i.remove(c+"version"),i.remove(c+"resources/default_app.asar");const d=s?`${c}${a}.app/Contents/`:c,p=s?d+"Resources/app/":d+"resources/app/",u=await I.getAppIcon(this.options.app.icon);i.file(p+"icon.png",u);const f={name:a,main:"electron-main.js",version:this.options.app.version};i.file(p+"package.json",JSON.stringify(f,null,4));const h=`'use strict';\nconst {app, BrowserWindow, Menu, shell, screen, dialog} = require('electron');\nconst path = require('path');\n\nconst isWindows = process.platform === 'win32';\nconst isMac = process.platform === 'darwin';\nconst isLinux = process.platform === 'linux';\n\nif (isMac) {\n  Menu.setApplicationMenu(Menu.buildFromTemplate([\n    { role: 'appMenu' },\n    { role: 'fileMenu' },\n    { role: 'editMenu' },\n    { role: 'windowMenu' },\n    { role: 'help' }\n  ]));\n} else {\n  Menu.setApplicationMenu(null);\n}\n\nconst resourcesURL = Object.assign(new URL('file://'), {\n  pathname: path.join(__dirname, '/')\n}).href;\nconst defaultProjectURL = new URL('./index.html', resourcesURL).href;\n\nconst createWindow = (windowOptions) => {\n  const options = {\n    title: ${JSON.stringify(this.options.app.windowTitle)},\n    icon: path.resolve(__dirname, ${JSON.stringify("icon.png")}),\n    useContentSize: true,\n    webPreferences: {\n      sandbox: true,\n      contextIsolation: true,\n      nodeIntegration: false,\n    },\n    show: true,\n    width: 480,\n    height: 360,\n    ...windowOptions,\n  };\n\n  const activeScreen = screen.getDisplayNearestPoint(screen.getCursorScreenPoint());\n  const bounds = activeScreen.workArea;\n  options.x = bounds.x + ((bounds.width - options.width) / 2);\n  options.y = bounds.y + ((bounds.height - options.height) / 2);\n\n  const window = new BrowserWindow(options);\n  return window;\n};\n\nconst createProjectWindow = (url) => {\n  const windowMode = ${JSON.stringify(this.options.app.windowMode)};\n  const options = {\n    show: false,\n    backgroundColor: ${JSON.stringify(this.options.appearance.background)},\n    width: ${this.computeWindowSize().width},\n    height: ${this.computeWindowSize().height},\n    minWidth: 50,\n    minHeight: 50,\n  };\n  // fullscreen === false disables fullscreen on macOS so only set this property when it's true\n  if (windowMode === 'fullscreen') {\n    options.fullscreen = true;\n  }\n  const window = createWindow(options);\n  if (windowMode === 'maximize') {\n    window.maximize();\n  }\n  window.loadURL(url);\n  window.show();\n};\n\nconst createDataWindow = (dataURI) => {\n  const window = createWindow({});\n  window.loadURL(dataURI);\n};\n\nconst isResourceURL = (url) => {\n  try {\n    const parsedUrl = new URL(url);\n    return parsedUrl.protocol === 'file:' && parsedUrl.href.startsWith(resourcesURL);\n  } catch (e) {\n    // ignore\n  }\n  return false;\n};\n\nconst SAFE_PROTOCOLS = [\n  'https:',\n  'http:',\n  'mailto:',\n];\n\nconst isSafeOpenExternal = (url) => {\n  try {\n    const parsedUrl = new URL(url);\n    return SAFE_PROTOCOLS.includes(parsedUrl.protocol);\n  } catch (e) {\n    // ignore\n  }\n  return false;\n};\n\nconst isDataURL = (url) => {\n  try {\n    const parsedUrl = new URL(url);\n    return parsedUrl.protocol === 'data:';\n  } catch (e) {\n    // ignore\n  }\n  return false;\n};\n\nconst openLink = (url) => {\n  if (isDataURL(url)) {\n    createDataWindow(url);\n  } else if (isResourceURL(url)) {\n    createProjectWindow(url);\n  } else if (isSafeOpenExternal(url)) {\n    shell.openExternal(url);\n  }\n};\n\napp.on('render-process-gone', (event, webContents, details) => {\n  const window = BrowserWindow.fromWebContents(webContents);\n  dialog.showMessageBoxSync(window, {\n    type: 'error',\n    title: 'Error',\n    message: 'Renderer process crashed: ' + details.reason + ' (' + details.exitCode + ')'\n  });\n});\n\napp.on('child-process-gone', (event, details) => {\n  dialog.showMessageBoxSync({\n    type: 'error',\n    title: 'Error',\n    message: details.type + ' child process crashed: ' + details.reason + ' (' + details.exitCode + ')'\n  });\n});\n\napp.on('web-contents-created', (event, contents) => {\n  contents.setWindowOpenHandler((details) => {\n    setImmediate(() => {\n      openLink(details.url);\n    });\n    return {action: 'deny'};\n  });\n  contents.on('will-navigate', (e, url) => {\n    if (!isResourceURL(url)) {\n      e.preventDefault();\n      openLink(url);\n    }\n  });\n  contents.on('before-input-event', (e, input) => {\n    const window = BrowserWindow.fromWebContents(contents);\n    if (!window || input.type !== "keyDown") return;\n    if (input.key === 'F11' || (input.key === 'Enter' && input.alt)) {\n      window.setFullScreen(!window.isFullScreen());\n    } else if (input.key === 'Escape' && window.isFullScreen()) {\n      window.setFullScreen(false);\n    }\n  });\n});\n\napp.on('window-all-closed', () => {\n  app.quit();\n});\n\napp.whenReady().then(() => {\n  createProjectWindow(defaultProjectURL);\n});\n`;i.file(p+"electron-main.js",h);for(const[n,t]of Object.entries(e.files))x(i,`${p}${n}`,t);if(o){const e=["1) Extract the whole zip",`2) Open "${a}.exe" to start the app.`,'Open "licenses.html" for information regarding open source software used by the app.'].join("\n\n");i.file(c+"README.txt",e)}else if(s){i.file(`How to run ${this.options.app.packageName}.txt`,k(this.options));const e=this.getPlistPropertiesForPrimaryExecutable();await this.updatePlist(i,d+"Info.plist",e);const n=["Electron Helper","Electron Helper (GPU)","Electron Helper (Renderer)","Electron Helper (Plugin)"];for(const t of n)await this.updatePlist(i,`${d}Frameworks/${t}.app/Contents/Info.plist`,{CFBundleIdentifier:e.CFBundleIdentifier+".helper",CFBundleDisplayName:t.replace("Electron",this.options.app.packageName),CFBundleVersion:this.options.app.version,CFBundleShortVersionString:this.options.app.version});const t=await w(u);i.file(d+"Resources/electron.icns",t)}else if(r){const e='#!/bin/bash\ncd "$(dirname "$0")"\n./'+a;i.file(c+"start.sh",e,{unixPermissions:33261})}return i}async addWebViewMac(e){const n=await this.fetchLargeAsset(this.options.target,"arraybuffer"),t=await(await O()).loadAsync(n),o=this.options.app.packageName+".app",s=o+"/Contents/",r=o+"/Contents/Resources/",i=new(await O());for(const[e,n]of Object.entries(t.files)){const t=e.replace("WebView.app",o).replace(/WebView$/,this.options.app.packageName);x(i,t,n)}for(const[n,t]of Object.entries(e.files))x(i,`${r}${n}`,t);const a=await I.getAppIcon(this.options.app.icon),c=await w(a);i.file(r+"AppIcon.icns",c),i.remove(r+"Assets.car");const l=parseInt(this.options.appearance.background.substr(1),16),d={title:this.options.app.windowTitle,background:[l>>16&255,l>>8&255,255&l,1],width:this.computeWindowSize().width,height:this.computeWindowSize().height};return i.file(r+"application_config.json",JSON.stringify(d)),await this.updatePlist(i,s+"Info.plist",this.getPlistPropertiesForPrimaryExecutable()),i.file(`How to run ${this.options.app.packageName}.txt`,k(this.options)),i}makeWebSocketProvider(){const e="wss://clouddata.turbowarp.org"===this.options.cloudVariables.cloudHost?["wss://clouddata.turbowarp.org","wss://clouddata.turbowarp.xyz"]:this.options.cloudVariables.cloudHost;return`new Scaffolding.Cloud.WebSocketProvider(${JSON.stringify(e)}, ${JSON.stringify(this.options.projectId)})`}makeLocalStorageProvider(){return`new Scaffolding.Cloud.LocalStorageProvider(${JSON.stringify("cloudvariables:"+this.options.projectId)})`}makeCustomProvider(){const e=this.options.cloudVariables.custom;let n="{const providers = {};\n";for(const t of new Set(Object.values(e)))"ws"===t?n+=`providers.ws = ${this.makeWebSocketProvider()};\n`:"local"===t&&(n+=`providers.local = ${this.makeLocalStorageProvider()};\n`);n+="for (const provider of Object.values(providers)) scaffolding.addCloudProvider(provider);\n";for(const t of Object.keys(e)){const o=e[t];n+=`scaffolding.addCloudProviderOverride(${JSON.stringify(t)}, providers[${JSON.stringify(o)}] || null);\n`}return n+="}",n}generateFilename(e){return`${this.options.app.windowTitle}.${e}`}async generateGetProjectData(){let e,n,t="",o="",s=!1;if("html"===this.options.target){s="blob"!==this.project.type,e=.75,n=.98;const c=1e5,l=(e=>{const n=e.byteLength;let t;if(n%4!=0){const o=new ArrayBuffer(n+(4-n%4)),s=new Uint8Array(e),r=new Uint8Array(o);for(let e=0;e<s.length;e++)r[e]=s[e];t=new Uint32Array(o)}else t=new Uint32Array(e);const o=n.toString(),s=new ArrayBuffer(o.length+1+5*t.byteLength/4),r=new Uint8Array(s);let i=0;for(let e=0;e<o.length;e++)r[i++]=o.charCodeAt(e)+49;r[i++]=44;const a=e=>60===(e+=42)?40:62===e?41:e;for(let e=0;e<t.length;e++){let n=t[e];r[i++]=a(n%85),n=Math.floor(n/85),r[i++]=a(n%85),n=Math.floor(n/85),r[i++]=a(n%85),n=Math.floor(n/85),r[i++]=a(n%85),n=Math.floor(n/85),r[i++]=a(n%85)}return(new TextDecoder).decode(s)})(this.project.arrayBuffer);for(let e=0;e<l.length;e+=c){t+=`<script type="p4-project">${l.substr(e,c)}<\/script><script>setProgress(${(r=.1,i=.75,a=e/l.length,r+a*(i-r)).toString().substr(1,4)})<\/script>`}o=`async () => {\n        const base85decode = ${y};\n        const dataElements = Array.from(document.querySelectorAll('script[type="p4-project"]'));\n        const result = base85decode(dataElements.map(i => i.textContent).join(''));\n        dataElements.forEach(i => i.remove());\n        return result;\n      }`}else{let t;"blob"===this.project.type||"zip-one-asset"===this.options.target?(s="blob"!==this.project.type,t="./project.zip",e=.75,n=.98):(t="./assets/project.json",e=.2,n=.98),o=`() => new Promise((resolve, reject) => {\n        const xhr = new XMLHttpRequest();\n        xhr.onload = () => {\n          resolve(xhr.response);\n        };\n        xhr.onerror = () => {\n          if (location.protocol === 'file:') {\n            reject(new Error('Zip environment must be used from a website, not from a file URL.'));\n          } else {\n            reject(new Error('Request to load project data failed.'));\n          }\n        };\n        xhr.onprogress = (e) => {\n          if (e.lengthComputable) {\n            setProgress(interpolate(0.1, ${e}, e.loaded / e.total));\n          }\n        };\n        xhr.responseType = 'arraybuffer';\n        xhr.open('GET', ${JSON.stringify(t)});\n        xhr.send();\n      })`}var r,i,a;return t+=`\n    <script>\n      const getProjectData = (function() {\n        const storage = scaffolding.storage;\n        storage.onprogress = (total, loaded) => {\n          setProgress(interpolate(${e}, ${n}, loaded / total));\n        };\n        ${s?`\n        let zip;\n        // Allow zip to be GC'd after project loads\n        vm.runtime.on('PROJECT_LOADED', () => (zip = null));\n        const findFileInZip = (path) => zip.file(path) || zip.file(new RegExp("^([^/]*/)?" + path + "$"))[0];\n        storage.addHelper({\n          load: (assetType, assetId, dataFormat) => {\n            if (!zip) {\n              throw new Error('Zip is not loaded or has been closed');\n            }\n            const path = assetId + '.' + dataFormat;\n            const file = findFileInZip(path);\n            if (!file) {\n              throw new Error('Asset is not in zip: ' + path)\n            }\n            return file\n              .async('uint8array')\n              .then((data) => storage.createAsset(assetType, dataFormat, data, assetId));\n          }\n        });\n        return () => (${o})().then(async (data) => {\n          zip = await Scaffolding.JSZip.loadAsync(data);\n          const file = findFileInZip('project.json');\n          if (!file) {\n            throw new Error('project.json is not in zip');\n          }\n          return file.async('arraybuffer');\n        });`:`\n        storage.addWebStore(\n          [storage.AssetType.ImageVector, storage.AssetType.ImageBitmap, storage.AssetType.Sound],\n          (asset) => new URL('./assets/' + asset.assetId + '.' + asset.dataFormat, location).href\n        );\n        return ${o};`}\n      })();\n    <\/script>`,t}async generateFavicon(){if(null===this.options.app.icon)return"";return`<link rel="icon" href="${await I.readAsURL(this.options.app.icon,"app icon")}">`}async generateCursor(){if("custom"!==this.options.cursor.type)return this.options.cursor.type;if(!this.options.cursor.custom)return"auto";return`url(${await I.readAsURL(this.options.cursor.custom,"custom cursor")}) ${this.options.cursor.center.x} ${this.options.cursor.center.y}, auto`}async generateExtensionURLs(){const e=e=>this.dispatchEvent(new o("fetch-extensions",{detail:{progress:e}})),n=e=>{if(!this.options.bakeExtensions)return!1;try{const n=new URL(e);return"http:"===n.protocol||"https:"===n.protocol}catch(e){return!1}},t=this.options.extensions.map(e=>e.url),s=t.filter(e=>!n(e)),r=t.filter(e=>n(e)),i=[...s];if(0!==r.length){for(let n=0;n<r.length;n++){e(n/r.length);const t=r[n];try{const e=await I.fetchExtensionScript(t),n="data:text/javascript;,"+encodeURIComponent(e);i.push(n)}catch(e){i.push(t)}}e(1)}return i}async package(){if(!I)throw new Error("Missing adapter");if(this.used)throw new Error("Packager was already used");this.used=!0,this.ensureNotAborted(),await this.loadResources(),this.ensureNotAborted();const e=`<!DOCTYPE html>\n\x3c!-- Created with ${S.WEBSITE} --\x3e\n<html>\n<head>\n  <meta charset="utf-8">\n  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">\n  \x3c!-- We only include this to explicitly loosen the CSP of various packager environments. It does not provide any security. --\x3e\n  <meta http-equiv="Content-Security-Policy" content="default-src * 'self' 'unsafe-inline' 'unsafe-eval' data: blob:">\n  <title>${r(this.options.app.windowTitle)}</title>\n  <style>\n    body {\n      color: ${this.options.appearance.foreground};\n      font-family: sans-serif;\n      overflow: hidden;\n      margin: 0;\n      padding: 0;\n    }\n    :root, body.is-fullscreen {\n      background-color: ${this.options.appearance.background};\n    }\n    [hidden] {\n      display: none !important;\n    }\n    h1 {\n      font-weight: normal;\n    }\n    a {\n      color: inherit;\n      text-decoration: underline;\n      cursor: pointer;\n    }\n\n    #app, #loading, #error, #launch {\n      position: absolute;\n      top: 0;\n      left: 0;\n      width: 100%;\n      height: 100%;\n    }\n    .screen {\n      display: flex;\n      flex-direction: column;\n      align-items: center;\n      justify-content: center;\n      text-align: center;\n      cursor: default;\n      user-select: none;\n      -webkit-user-select: none;\n      background-color: ${this.options.appearance.background};\n    }\n    #launch {\n      background-color: rgba(0, 0, 0, 0.7);\n      cursor: pointer;\n    }\n    .green-flag {\n      width: 80px;\n      height: 80px;\n      padding: 16px;\n      border-radius: 100%;\n      background: rgba(255, 255, 255, 0.75);\n      border: 3px solid hsla(0, 100%, 100%, 1);\n      display: flex;\n      justify-content: center;\n      align-items: center;\n      box-sizing: border-box;\n    }\n    #loading {\n      ${this.options.loadingScreen.image&&"stretch"===this.options.loadingScreen.imageMode?`background-image: url(${await I.readAsURL(this.options.loadingScreen.image,"stretched loading screen")});\n      background-repeat: no-repeat;\n      background-size: contain;\n      background-position: center;`:""}\n    }\n    .progress-bar-outer {\n      border: 1px solid currentColor;\n      height: 10px;\n      width: 200px;\n      max-width: 200px;\n    }\n    .progress-bar-inner {\n      height: 100%;\n      width: 0;\n      background-color: currentColor;\n    }\n    .loading-text, noscript {\n      font-weight: normal;\n      font-size: 36px;\n      margin: 0 0 16px;\n    }\n    .loading-image {\n      margin: 0 0 16px;\n    }\n    #error-message, #error-stack {\n      font-family: monospace;\n      max-width: 600px;\n      white-space: pre-wrap;\n      user-select: text;\n      -webkit-user-select: text;\n    }\n    #error-stack {\n      text-align: left;\n      max-height: 200px;\n      overflow: auto;\n    }\n    .control-button {\n      width: 2rem;\n      height: 2rem;\n      padding: 0.375rem;\n      border-radius: 0.25rem;\n      margin-top: 0.5rem;\n      margin-bottom: 0.5rem;\n      user-select: none;\n      -webkit-user-select: none;\n      cursor: pointer;\n      border: 0;\n      border-radius: 4px;\n    }\n    .control-button:hover {\n      background: ${this.options.appearance.accent}26;\n    }\n    .control-button.active {\n      background: ${this.options.appearance.accent}59;\n    }\n    .fullscreen-button {\n      background: white !important;\n    }\n    .standalone-fullscreen-button {\n      position: absolute;\n      top: 0;\n      right: 0;\n      background-color: rgba(0, 0, 0, 0.5);\n      border-radius: 0 0 0 4px;\n      padding: 4px;\n      cursor: pointer;\n    }\n    .sc-canvas {\n      cursor: ${await this.generateCursor()};\n    }\n    .sc-monitor-root[opcode^="data_"] .sc-monitor-value-color {\n      background-color: ${this.options.monitors.variableColor};\n    }\n    .sc-monitor-row-value-outer {\n      background-color: ${this.options.monitors.listColor};\n    }\n    .sc-monitor-row-value-editing .sc-monitor-row-value-outer {\n      background-color: ${A(this.options.monitors.listColor)};\n    }\n    ${this.options.custom.css}\n  </style>\n  <meta name="theme-color" content="${this.options.appearance.background}">\n  ${await this.generateFavicon()}\n</head>\n<body>\n  <div id="app"></div>\n\n  <div id="launch" class="screen" hidden title="Click to start">\n    <div class="green-flag">\n      <svg viewBox="0 0 16.63 17.5" width="42" height="44">\n        <defs><style>.cls-1,.cls-2{fill:#4cbf56;stroke:#45993d;stroke-linecap:round;stroke-linejoin:round;}.cls-2{stroke-width:1.5px;}</style></defs>\n        <path class="cls-1" d="M.75,2A6.44,6.44,0,0,1,8.44,2h0a6.44,6.44,0,0,0,7.69,0V12.4a6.44,6.44,0,0,1-7.69,0h0a6.44,6.44,0,0,0-7.69,0"/>\n        <line class="cls-2" x1="0.75" y1="16.75" x2="0.75" y2="0.75"/>\n      </svg>\n    </div>\n  </div>\n\n  <div id="loading" class="screen">\n    <noscript>Enable JavaScript</noscript>\n    ${this.options.loadingScreen.text?`<h1 class="loading-text">${r(this.options.loadingScreen.text)}</h1>`:""}\n    ${this.options.loadingScreen.image&&"normal"===this.options.loadingScreen.imageMode?`<div class="loading-image"><img src="${await I.readAsURL(this.options.loadingScreen.image,"loading-screen")}"></div>`:""}\n    ${this.options.loadingScreen.progressBar?'<div class="progress-bar-outer"><div class="progress-bar-inner" id="loading-inner"></div></div>':""}\n  </div>\n\n  <div id="error" class="screen" hidden>\n    <h1>Error</h1>\n    <details>\n      <summary id="error-message"></summary>\n      <p id="error-stack"></p>\n    </details>\n  </div>\n\n  ${"html"===this.options.target?`<script>${this.script}<\/script>`:'<script src="script.js"><\/script>'}\n  <script>${n=`\n    const appElement = document.getElementById('app');\n    const launchScreen = document.getElementById('launch');\n    const loadingScreen = document.getElementById('loading');\n    const loadingInner = document.getElementById('loading-inner');\n    const errorScreen = document.getElementById('error');\n    const errorScreenMessage = document.getElementById('error-message');\n    const errorScreenStack = document.getElementById('error-stack');\n\n    const handleError = (error) => {\n      console.error(error);\n      if (!errorScreen.hidden) return;\n      errorScreen.hidden = false;\n      errorScreenMessage.textContent = '' + error;\n      let debug = error && error.stack || 'no stack';\n      debug += '\\nUser agent: ' + navigator.userAgent;\n      errorScreenStack.textContent = debug;\n    };\n    const setProgress = (progress) => {\n      if (loadingInner) loadingInner.style.width = progress * 100 + '%';\n    };\n    const interpolate = (a, b, t) => a + t * (b - a);\n\n    try {\n      setProgress(0.1);\n\n      const scaffolding = new Scaffolding.Scaffolding();\n      scaffolding.width = ${this.options.stageWidth};\n      scaffolding.height = ${this.options.stageHeight};\n      scaffolding.resizeMode = ${JSON.stringify(this.options.resizeMode)};\n      scaffolding.editableLists = ${this.options.monitors.editableLists};\n      scaffolding.usePackagedRuntime = ${this.options.packagedRuntime};\n      scaffolding.setup();\n      scaffolding.appendTo(appElement);\n\n      const vm = scaffolding.vm;\n      window.scaffolding = scaffolding;\n      window.vm = scaffolding.vm;\n      window.Scratch = {\n        vm,\n        renderer: vm.renderer,\n        audioEngine: vm.runtime.audioEngine,\n        bitmapAdapter: vm.runtime.v2BitmapAdapter,\n        videoProvider: vm.runtime.ioDevices.video.provider\n      };\n\n      scaffolding.setUsername(${JSON.stringify(this.options.username)}.replace(/#/g, () => Math.floor(Math.random() * 10)));\n      scaffolding.setAccentColor(${JSON.stringify(this.options.appearance.accent)});\n\n      ${"ws"===this.options.cloudVariables.mode?`scaffolding.addCloudProvider(${this.makeWebSocketProvider()})`:"local"===this.options.cloudVariables.mode?`scaffolding.addCloudProvider(${this.makeLocalStorageProvider()})`:"custom"===this.options.cloudVariables.mode?this.makeCustomProvider():""};\n\n      ${this.options.controls.greenFlag.enabled?'\n      const greenFlagButton = document.createElement(\'img\');\n      greenFlagButton.src = \'data:image/svg+xml,\' + encodeURIComponent(\'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16.63 17.5"><path d="M.75 2a6.44 6.44 0 017.69 0h0a6.44 6.44 0 007.69 0v10.4a6.44 6.44 0 01-7.69 0h0a6.44 6.44 0 00-7.69 0" fill="#4cbf56" stroke="#45993d" stroke-linecap="round" stroke-linejoin="round"/><path stroke-width="1.5" fill="#4cbf56" stroke="#45993d" stroke-linecap="round" stroke-linejoin="round" d="M.75 16.75v-16"/></svg>\');\n      greenFlagButton.className = \'control-button\';\n      greenFlagButton.draggable = false;\n      greenFlagButton.addEventListener(\'click\', () => {\n        scaffolding.greenFlag();\n      });\n      scaffolding.addEventListener(\'PROJECT_RUN_START\', () => {\n        greenFlagButton.classList.add(\'active\');\n      });\n      scaffolding.addEventListener(\'PROJECT_RUN_STOP\', () => {\n        greenFlagButton.classList.remove(\'active\');\n      });\n      scaffolding.addControlButton({\n        element: greenFlagButton,\n        where: \'top-left\'\n      });':""}\n\n      ${this.options.controls.pause.enabled?'\n      const pauseButton = document.createElement(\'img\');\n      pauseButton.className = \'control-button\';\n      pauseButton.draggable = false;\n      let isPaused = false;\n      pauseButton.addEventListener(\'click\', () => {\n        vm.setPaused(!isPaused);\n      });\n      const updatePause = (_isPaused) => {\n        isPaused = _isPaused;\n        if (isPaused) {\n          pauseButton.src = \'data:image/svg+xml,\' + encodeURIComponent(\'<svg width="16" height="16" viewBox="0 0 4.2333332 4.2333335" xmlns="http://www.w3.org/2000/svg"><path d="m3.95163484 2.02835365-1.66643921.9621191-1.66643913.96211911V.10411543l1.66643922.9621191z" fill="#ffae00"/></svg>\');\n        } else {\n          pauseButton.src = \'data:image/svg+xml,\' + encodeURIComponent(\'<svg width="16" height="16" viewBox="0 0 4.2333332 4.2333335" xmlns="http://www.w3.org/2000/svg"><g fill="#ffae00"><path d="M.389.19239126h1.2631972v3.8485508H.389zM2.5810001.19239126h1.2631972v3.8485508H2.5810001z"/></g></svg>\');\n        }\n      }\n      vm.on(\'P4_PAUSE\', updatePause);\n      updatePause();\n      scaffolding.addControlButton({\n        element: pauseButton,\n        where: \'top-left\'\n      });':""}\n\n      ${this.options.controls.stopAll.enabled?'\n      const stopAllButton = document.createElement(\'img\');\n      stopAllButton.src = \'data:image/svg+xml,\' + encodeURIComponent(\'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 14 14"><path fill="#ec5959" stroke="#b84848" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="10" d="M4.3.5h5.4l3.8 3.8v5.4l-3.8 3.8H4.3L.5 9.7V4.3z"/></svg>\');\n      stopAllButton.className = \'control-button\';\n      stopAllButton.draggable = false;\n      stopAllButton.addEventListener(\'click\', () => {\n        scaffolding.stopAll();\n      });\n      scaffolding.addControlButton({\n        element: stopAllButton,\n        where: \'top-left\'\n      });':""}\n\n      ${this.options.controls.fullscreen.enabled?`\n      if (document.fullscreenEnabled || document.webkitFullscreenEnabled) {\n        let isFullScreen = !!(document.fullscreenElement || document.webkitFullscreenElement);\n        const fullscreenButton = document.createElement('img');\n        fullscreenButton.draggable = false;\n        fullscreenButton.className = 'control-button fullscreen-button';\n        fullscreenButton.addEventListener('click', () => {\n          if (isFullScreen) {\n            if (document.exitFullscreen) {\n              document.exitFullscreen();\n            } else if (document.webkitExitFullscreen) {\n              document.webkitExitFullscreen();\n            }\n          } else {\n            if (document.body.requestFullscreen) {\n              document.body.requestFullscreen();\n            } else if (document.body.webkitRequestFullscreen) {\n              document.body.webkitRequestFullscreen();\n            }\n          }\n        });\n        const otherControlsExist = ${this.options.controls.greenFlag.enabled||this.options.controls.stopAll.enabled};\n        const fillColor = otherControlsExist ? '#575E75' : '${this.options.appearance.foreground}';\n        const updateFullScreen = () => {\n          isFullScreen = !!(document.fullscreenElement || document.webkitFullscreenElement);\n          document.body.classList.toggle('is-fullscreen', isFullScreen);\n          if (isFullScreen) {\n            fullscreenButton.src = 'data:image/svg+xml,' + encodeURIComponent('<svg width="20" height="20" xmlns="http://www.w3.org/2000/svg"><g fill="' + fillColor + '" fill-rule="evenodd"><path d="M12.662 3.65l.89.891 3.133-2.374a.815.815 0 011.15.165.819.819 0 010 .986L15.467 6.46l.867.871c.25.25.072.664-.269.664L12.388 8A.397.397 0 0112 7.611V3.92c0-.341.418-.514.662-.27M7.338 16.35l-.89-.89-3.133 2.374a.817.817 0 01-1.15-.166.819.819 0 010-.985l2.37-3.143-.87-.871a.387.387 0 01.27-.664L7.612 12a.397.397 0 01.388.389v3.692a.387.387 0 01-.662.27M7.338 3.65l-.89.891-3.133-2.374a.815.815 0 00-1.15.165.819.819 0 000 .986l2.37 3.142-.87.871a.387.387 0 00.27.664L7.612 8A.397.397 0 008 7.611V3.92a.387.387 0 00-.662-.27M12.662 16.35l.89-.89 3.133 2.374a.817.817 0 001.15-.166.819.819 0 000-.985l-2.368-3.143.867-.871a.387.387 0 00-.269-.664L12.388 12a.397.397 0 00-.388.389v3.692c0 .342.418.514.662.27"/></g></svg>');\n          } else {\n            fullscreenButton.src = 'data:image/svg+xml,' + encodeURIComponent('<svg width="20" height="20" xmlns="http://www.w3.org/2000/svg"><g fill="' + fillColor + '" fill-rule="evenodd"><path d="M16.338 7.35l-.89-.891-3.133 2.374a.815.815 0 01-1.15-.165.819.819 0 010-.986l2.368-3.142-.867-.871a.387.387 0 01.269-.664L16.612 3a.397.397 0 01.388.389V7.08a.387.387 0 01-.662.27M3.662 12.65l.89.89 3.133-2.374a.817.817 0 011.15.166.819.819 0 010 .985l-2.37 3.143.87.871c.248.25.071.664-.27.664L3.388 17A.397.397 0 013 16.611V12.92c0-.342.418-.514.662-.27M3.662 7.35l.89-.891 3.133 2.374a.815.815 0 001.15-.165.819.819 0 000-.986L6.465 4.54l.87-.871a.387.387 0 00-.27-.664L3.388 3A.397.397 0 003 3.389V7.08c0 .341.418.514.662.27M16.338 12.65l-.89.89-3.133-2.374a.817.817 0 00-1.15.166.819.819 0 000 .985l2.368 3.143-.867.871a.387.387 0 00.269.664l3.677.005a.397.397 0 00.388-.389V12.92a.387.387 0 00-.662-.27"/></g></svg>');\n          }\n        };\n        updateFullScreen();\n        document.addEventListener('fullscreenchange', updateFullScreen);\n        document.addEventListener('webkitfullscreenchange', updateFullScreen);\n        if (otherControlsExist) {\n          fullscreenButton.className = 'control-button fullscreen-button';\n          scaffolding.addControlButton({\n            element: fullscreenButton,\n            where: 'top-right'\n          });\n        } else {\n          fullscreenButton.className = 'standalone-fullscreen-button';\n          document.body.appendChild(fullscreenButton);\n        }\n      }`:""}\n\n      vm.setTurboMode(${this.options.turbo});\n      if (vm.setInterpolation) vm.setInterpolation(${this.options.interpolation});\n      if (vm.setFramerate) vm.setFramerate(${this.options.framerate});\n      if (vm.renderer.setUseHighQualityRender) vm.renderer.setUseHighQualityRender(${this.options.highQualityPen});\n      if (vm.setRuntimeOptions) vm.setRuntimeOptions({\n        fencing: ${this.options.fencing},\n        miscLimits: ${this.options.miscLimits},\n        maxClones: ${this.options.maxClones},\n      });\n      if (vm.setCompilerOptions) vm.setCompilerOptions({\n        enabled: ${this.options.compiler.enabled},\n        warpTimer: ${this.options.compiler.warpTimer}\n      });\n\n      if (typeof ScaffoldingAddons !== 'undefined') {\n        ScaffoldingAddons.run(scaffolding, ${JSON.stringify(this.getAddonOptions())});\n      }\n\n      scaffolding.setExtensionSecurityManager({\n        getSandboxMode: 'unsandboxed',\n        canLoadExtensionFromProject: (url) => {\n          handleError(new Error('Missing custom extension: ' + url));\n          return Promise.resolve(false);\n        }\n      });\n      for (const extension of ${JSON.stringify(await this.generateExtensionURLs())}) {\n        vm.extensionManager.loadExtensionURL(extension);\n      }\n\n      ${this.options.closeWhenStopped?"vm.runtime.on('PROJECT_RUN_STOP', () => window.close());":""}\n\n      ${this.options.target.startsWith("nwjs-")?"\n      if (typeof nw !== 'undefined') {\n        const win = nw.Window.get();\n        win.on('new-win-policy', (frame, url, policy) => {\n          policy.ignore();\n          nw.Shell.openExternal(url);\n        });\n        win.on('navigation', (frame, url, policy) => {\n          policy.ignore();\n          nw.Shell.openExternal(url);\n        });\n        document.addEventListener('keydown', (e) => {\n          if (e.key === 'Escape' && document.fullscreenElement) {\n            document.exitFullscreen();\n          }\n        });\n      }":""}\n    } catch (e) {\n      handleError(e);\n    }\n  `,n.split("\n").filter((e,n,t)=>0===n||n===t.length-1||0!==e.trim().length||0!==t[n-1].trim().length).join("\n")}<\/script>\n  ${this.options.custom.js?`<script>\n    try {\n      ${this.options.custom.js}\n    } catch (e) {\n      handleError(e);\n    }\n  <\/script>`:""}\n  ${await this.generateGetProjectData()}\n  <script>\n    const run = async () => {\n      const projectData = await getProjectData();\n      await scaffolding.loadProject(projectData);\n      setProgress(1);\n      loadingScreen.hidden = true;\n      if (${this.options.autoplay}) {\n        scaffolding.start();\n      } else {\n        launchScreen.hidden = false;\n        launchScreen.addEventListener('click', () => {\n          launchScreen.hidden = true;\n          scaffolding.start();\n        });\n        launchScreen.focus();\n      }\n    };\n    run().catch(handleError);\n  <\/script>\n</body>\n</html>\n`;var n;if(this.ensureNotAborted(),"html"!==this.options.target){let n;if("sb3"===this.project.type&&"zip-one-asset"!==this.options.target){n=await(await O()).loadAsync(this.project.arrayBuffer);for(const e of Object.keys(n.files))n.files["assets/"+e]=n.files[e],delete n.files[e]}else n=new(await O()),n.file("project.zip",this.project.arrayBuffer);return n.file("index.html",e),n.file("script.js",this.script),this.options.target.startsWith("nwjs-")?n=await this.addNwJS(n):this.options.target.startsWith("electron-")?n=await this.addElectron(n):"webview-mac"===this.options.target&&(n=await this.addWebViewMac(n)),this.ensureNotAborted(),{data:await n.generateAsync({type:"arraybuffer",compression:"DEFLATE",platform:"UNIX"},e=>{this.dispatchEvent(new o("zip-progress",{detail:{progress:e.percent/100}}))}),type:"application/zip",filename:this.generateFilename("zip")}}return{data:e,type:"text/html",filename:this.generateFilename("html")}}}P.getDefaultPackageNameFromFileName=e=>(e=(e=(e=(e=e.split(".")[0]).replace(/[^\-a-z ]/gi,"")).trim()).replace(/ /g,"-")).toLowerCase()||"packaged-project",P.getWindowTitleFromFileName=e=>{const n=e.split(".");return n.length>1&&n.pop(),(e=n.join(".").trim())||"Packaged Project"},P.usesUnsafeOptions=e=>{const n=P.DEFAULT_OPTIONS(),t=e=>[e.custom,e.extensions,e.cloudVariables.unsafeCloudBehaviors];return JSON.stringify(t(n))!==JSON.stringify(t(e))},P.DEFAULT_OPTIONS=()=>({turbo:!1,interpolation:!1,framerate:30,highQualityPen:!1,maxClones:300,fencing:!0,miscLimits:!0,stageWidth:480,stageHeight:360,resizeMode:"preserve-ratio",autoplay:!1,username:"player####",closeWhenStopped:!1,projectId:"",custom:{css:"",js:""},appearance:{background:"#000000",foreground:"#ffffff",accent:S.ACCENT_COLOR},loadingScreen:{progressBar:!0,text:"",imageMode:"normal",image:null},controls:{greenFlag:{enabled:!1},stopAll:{enabled:!1},fullscreen:{enabled:!1},pause:{enabled:!1}},monitors:{editableLists:!1,variableColor:"#ff8c1a",listColor:"#fc662c"},compiler:{enabled:!0,warpTimer:!1},packagedRuntime:!0,target:"html",app:{icon:null,packageName:P.getDefaultPackageNameFromFileName(""),windowTitle:P.getWindowTitleFromFileName(""),windowMode:"window",version:"1.0.0"},chunks:{gamepad:!1,pointerlock:!1},cloudVariables:{mode:"ws",cloudHost:"wss://clouddata.turbowarp.org",custom:{},specialCloudBehaviors:!1,unsafeCloudBehaviors:!1},cursor:{type:"auto",custom:null,center:{x:0,y:0}},extensions:[],bakeExtensions:!0});var j=P;const $="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!#%()*+,-./:;=?@[]^_`{|}~",B=e=>{e>1309&&e++;let n="";for(;e>=0;)n=$[e%$.length]+n,e=Math.floor(e/$.length)-1;return n};class F{constructor(){this.generatedIds=new Map,this.references=new Map}addReference(e){const n=this.references.get(e)||0;this.references.set(e,n+1)}generateNewIds(){const e=Array.from(this.references.entries());e.sort((e,n)=>n[1]-e[1]);for(let n=0;n<e.length;n++)this.generatedIds.set(e[n][0],B(n))}getNewId(e){if(this.generatedIds.has(e))return this.generatedIds.get(e);throw new Error("getNewId called with unknown ID "+e)}}var M=e=>{const n=new F,t=new F;if(e.monitors)for(const t of e.monitors){const e=t.opcode;if("data_variable"===e||"data_listcontents"===e){const e=t.id;n.addReference(e)}}const o=e=>{const t=e[0];if(12===t||13===t){const t=e[2];n.addReference(t)}else if(11===t){const t=e[2];n.addReference(t)}};for(const s of e.targets){for(const e of Object.keys(s.variables))n.addReference(e);for(const e of Object.keys(s.lists))n.addReference(e);for(const e of Object.keys(s.broadcasts))n.addReference(e);for(const[e,r]of Object.entries(s.blocks))if(t.addReference(e),Array.isArray(r))o(r);else{r.parent&&t.addReference(r.parent),r.next&&t.addReference(r.next),r.fields.VARIABLE&&n.addReference(r.fields.VARIABLE[1]),r.fields.LIST&&n.addReference(r.fields.LIST[1]),r.fields.BROADCAST_OPTION&&n.addReference(r.fields.BROADCAST_OPTION[1]);for(const e of Object.values(r.inputs))for(let n=1;n<e.length;n++){const s=e[n];"string"==typeof s?t.addReference(s):Array.isArray(s)&&o(s)}}}if(n.generateNewIds(),t.generateNewIds(),e.monitors)for(const t of e.monitors){const e=t.opcode;if("data_variable"===e||"data_listcontents"===e){const e=t.id;t.id=n.getNewId(e)}t.value=Array.isArray(t.value)?[]:0}const s=e=>{const t=e[0];if(12===t||13===t){const t=e[2];e[2]=n.getNewId(t)}else if(11===t){const t=e[2];e[2]=n.getNewId(t)}};for(const o of e.targets){const e={},r={},i={},a={},c={};for(const[t,s]of Object.entries(o.variables))e[n.getNewId(t)]=s;for(const[e,t]of Object.entries(o.lists))r[n.getNewId(e)]=t;for(const[e,t]of Object.entries(o.broadcasts))i[n.getNewId(e)]=t;for(const[e,r]of Object.entries(o.blocks))if(a[t.getNewId(e)]=r,Array.isArray(r))s(r);else{r.parent&&(r.parent=t.getNewId(r.parent)),r.next&&(r.next=t.getNewId(r.next)),r.fields.VARIABLE&&(r.fields.VARIABLE[1]=n.getNewId(r.fields.VARIABLE[1])),r.fields.LIST&&(r.fields.LIST[1]=n.getNewId(r.fields.LIST[1])),r.fields.BROADCAST_OPTION&&(r.fields.BROADCAST_OPTION[1]=n.getNewId(r.fields.BROADCAST_OPTION[1]));for(const e of Object.values(r.inputs))for(let n=1;n<e.length;n++){const o=e[n];"string"==typeof o?e[n]=t.getNewId(o):Array.isArray(o)&&s(o)}r.shadow||delete r.shadow,r.topLevel||delete r.topLevel,delete r.x,delete r.y,delete r.comment}for(const[e,n]of Object.entries(o.comments)){const t=n.text;(t.includes(" // _twconfig_")||t.includes(" // _gamepad_"))&&(c[e]=n)}o.variables=e,o.lists=r,o.broadcasts=i,o.blocks=a,o.comments=c}return e.meta&&(delete e.meta.agent,delete e.meta.vm),e},U=t(5);const D=async(e,n=(()=>{}))=>{let t={stageVariables:[],stageComments:[],usesMusic:!0,extensions:[]};const o={onProgress(e,t,o){n(e,t,o)},processJSON(e,n){if("sb3"===e)return(e=>{(e=>{const n=e.targets.find(e=>e.isStage);if(n)for(const e of Object.values(n.variables)){e[0].startsWith("☁")&&(e[2]=!0)}})(e),M(e)})(n),t=(e=>{const n=e.targets[0];if(!n||!n.isStage)throw new Error("Project does not have stage");return{stageVariables:[],stageComments:[],usesMusic:!0,extensions:[],stageVariables:Object.values(n.variables).map(([e,n,t])=>({name:e,isCloud:!!t})),stageComments:Object.values(n.comments).map(e=>e.text),usesMusic:e.extensions.includes("music"),extensions:e.extensionURLs?Object.values(e.extensionURLs):[]}})(n),n;"sb2"===e&&(t=(e=>{const n=(e.variables||[]).map(({name:e,isPersistent:n})=>({name:e,isCloud:n})),t=JSON.stringify(e);return{stageVariables:[],stageComments:[],usesMusic:!0,extensions:[],stageVariables:n,usesMusic:t.includes("drum:duration:elapsed:from:")||t.includes("playDrum")||t.includes("noteOn:duration:elapsed:from:")}})(n))}},s=await Object(U.downloadProjectFromBuffer)(e,o);return"sb3"!==s.type&&(s.type="blob"),s.analysis=t,s};var W=t(3),z=t.n(W),_=t(1),H=t.n(_),V=t(2),J=t(4),G=t.n(J),Y=t(6),q=t.p+"290e09e569a1cab8e61ba93b0d23863f.png";var X=class{constructor(e,n){this.mimeType=e,this.buffer=Buffer.from(n)}readAsURL(){return`data:${this.mimeType};base64,${this.buffer.toString("base64")}`}readAsBuffer(){return this.buffer}};const Z=Object(V.promisify)(z.a.readFile),Q=Object(V.promisify)(z.a.writeFile),K=Object(V.promisify)(z.a.mkdir),ee=(e,n)=>{e=H.a.join(e,"/");const t=H.a.join(e,n);return t.startsWith(e)?t:null},ne=H.a.join(__dirname,"..",".packager-cache");var te;te=new class{async getCachedAsset(e){const n=e.src,t=Array.isArray(n)?n[0]:n;if(t.startsWith("scaffolding/")){const e=ee(__dirname,t);if(e)return Z(e,"utf-8")}if(t.startsWith("https:")){const n=await(async e=>{if(!e.sha256)return null;const n=ee(ne,e.sha256);return n?(await K(ne,{recursive:!0}),n):null})(e);if(n)try{return(o=await Z(n)).buffer.slice(o.byteOffset,o.byteOffset+o.byteLength)}catch(e){}console.log(`[${Y.a}]: downloading large asset ${t}; this may take a while`);const s=await G()(t);if(!s.ok)throw new Error("Unexpected status code: "+s.status);const r=await s.arrayBuffer();return n&&await Q(n,(e=>Buffer.from(e))(r)),r}var o}async cacheAsset(e,n){}async getAppIcon(e){if(!e){const e=await Z(H.a.join(__dirname,q));return e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)}if(e instanceof X){if("image/png"===e.mimeType)return e.readAsBuffer();throw new Error("icon must be of type image/png but found "+e.mimeType+" instead.")}throw new Error("file must be an instance of Packager.Image or null but found "+e+" instead.")}readAsURL(e){if(!(e instanceof X))throw new Error("file must be an instance of Packager.Image but found "+e+" instead.");return e.readAsURL()}fetchExtensionScript(e){return G()(e).then(e=>{if(e.ok)return e.text();throw new Error("Unexpected status code: "+e.status)})}},I=te},function(e,n){e.exports=require("buffer")},function(e,n){e.exports=t},function(e,n){e.exports=o}])}));